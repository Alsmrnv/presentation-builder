"""
Промпты для генерации визуализаций через LLM

ДОСТУПНЫЕ ТИПЫ ВИЗУАЛИЗАЦИЙ:
- "line": линейный график (тренды, временные ряды)
- "bar": столбчатая диаграмма (сравнение категорий)
- "pie": круговая диаграмма (доли, распределения)
- "scatter": точечная диаграмма (корреляции, зависимости)
- "histogram": гистограмма (распределения, частоты)
- "table": таблица (структурированные данные)

ИСПОЛЬЗОВАНИЕ:
    from visgen.prompts import get_visualization_prompt

    prompt = get_visualization_prompt(
        vis_type="table",
        data_context="Финансовые метрики: выручка=1.2M, EBITDA=300k, чистая прибыль=180k",
        chart_title="Финансовая сводка"
    )
"""

from typing import Dict

VISUALIZATION_PROMPTS: Dict[str, str] = {
    "line": """
Ты специалист по визуализации данных. Создай JSON конфигурацию для линейного графика.

# ДАННЫЕ ДЛЯ ГРАФИКА:
{data_context}

# НАЗВАНИЕ ГРАФИКА:
{title_section}

# ФОРМАТ ОТВЕТА - строго JSON:
{{
  "type": "plotly",
  "chart_type": "line",
  "data": {{
    "x": ["янв", "фев", "мар"],  # массив строк (метки оси X)
    "y": [100, 150, 130]         # массив чисел (значения оси Y)
  }},
  "layout": {{
    "title": "Краткий заголовок",      # строка до 50 символов
    "xaxis_title": "Название оси X",   # строка до 30 символов
    "yaxis_title": "Название оси Y"    # строка до 30 символов
  }}
}}

# ПРАВИЛА И ОГРАНИЧЕНИЯ:
1. БЕЗОПАСНОСТЬ:
   - Только допустимые типы: строки в X, числа в Y
   - Минимум 3 точки данных для осмысленного графика
   - Оптимально 5-15 точек данных
   - Запрещены символы: < > {{ }} ` $ & | ;

2. ВАЛИДАЦИЯ:
   - Массивы x и y ДОЛЖНЫ быть одинаковой длины
   - Все элементы в y должны быть числами
   - Подписи должны быть краткими и понятными

3. КАЧЕСТВО:
   - Если данных слишком мало (< минимум) или слишком много (> максимум) - 
    выбери другой тип визуализации или агрегируй данные
   - Заголовок должен отражать суть данных
   - Подписи осей должны быть информативными
   - Используй короткие метки для оси X (месяцы, кварталы, дни)

# ПРИМЕРЫ:

ХОРОШО:
{{
  "type": "plotly",
  "chart_type": "line",
  "data": {{
    "x": ["Янв", "Фев", "Мар", "Апр"],
    "y": [45000, 52000, 48000, 61000]
  }},
  "layout": {{
    "title": "Продажи по месяцам",
    "xaxis_title": "Месяц",
    "yaxis_title": "Продажи, руб"
  }}
}}

НЕПРАВИЛЬНО (разная длина массивов):
{{
  "data": {{
    "x": ["Янв", "Фев", "Мар"],
    "y": [100, 150]  // ОШИБКА: 3 элемента в x, но 2 в y
  }}
}}

Верни ТОЛЬКО JSON без дополнительного текста.
""",
    "bar": """
Ты специалист по визуализации данных. Создай JSON конфигурацию для столбчатой диаграммы.

# ДАННЫЕ ДЛЯ ГРАФИКА:
{data_context}

# НАЗВАНИЕ ГРАФИКА:
{title_section}

# ФОРМАТ ОТВЕТА - строго JSON:
{{
  "type": "plotly",
  "chart_type": "bar",
  "data": {{
    "x": ["Москва", "Питер", "Казань"],  # массив строк (категории)
    "y": [120, 90, 75]                   # массив чисел (значения)
  }},
  "layout": {{
    "title": "Краткий заголовок",      # строка до 50 символов
    "xaxis_title": "Категория",        # строка до 30 символов
    "yaxis_title": "Значение"          # строка до 30 символов
  }}
}}

# ПРАВИЛА И ОГРАНИЧЕНИЯ:
1. БЕЗОПАСНОСТЬ:
   - Только допустимые типы: строки в X, числа в Y
   - Минимум 2 категории для сравнения
   - Оптимально 3-8 категорий
   - Максимум 12 категорий для читаемости
   - Запрещены символы: < > {{ }} ` $ & | ;

2. ВАЛИДАЦИЯ:
   - Массивы x и y ДОЛЖНЫ быть одинаковой длины
   - Все элементы в y должны быть числами
   - Подписи должны быть краткими и понятными

3. КАЧЕСТВО:
   - Если данных слишком мало (< минимум) или слишком много (> максимум) - 
  выбери другой тип визуализации или агрегируй данные
   - Заголовок должен отражать суть данных
   - Подписи осей должны быть информативными
   - Используй короткие метки для оси X (до 15 символов)

# ПРИМЕРЫ:

ХОРОШО:
{{
  "type": "plotly",
  "chart_type": "bar",
  "data": {{
    "x": ["Москва", "Питер", "Казань"],
    "y": [120000, 95000, 78000]
  }},
  "layout": {{
    "title": "Продажи по регионам",
    "xaxis_title": "Регион",
    "yaxis_title": "Продажи, руб"
  }}
}}

НЕПРАВИЛЬНО (разная длина массивов):
{{
  "data": {{
    "x": ["A", "B", "C"],
    "y": [10, 20]  // ОШИБКА: 3 элемента в x, но 2 в y
  }}
}}

Верни ТОЛЬКО JSON без дополнительного текста.
""",
    "pie": """
Ты специалист по визуализации данных. Создай JSON конфигурацию для круговой диаграммы.

# ДАННЫЕ ДЛЯ ГРАФИКА:
{data_context}

# НАЗВАНИЕ ГРАФИКА:
{title_section}

# ФОРМАТ ОТВЕТА - строго JSON:
{{
  "type": "plotly",
  "chart_type": "pie",
  "data": {{
    "labels": ["Продукт A", "Продукт B", "Продукт C"],  # массив строк (названия сегментов)
    "values": [45, 30, 25]                              # массив чисел (доли/значения)
  }},
  "layout": {{
    "title": "Краткий заголовок"  # строка до 50 символов
  }}
}}

# ПРАВИЛА И ОГРАНИЧЕНИЯ:
1. БЕЗОПАСНОСТЬ:
   - Только строки в labels, числа в values
   - Минимум 2 сегмента
   - Оптимально 3-6 сегментов
   - Максимум 8 сегментов для читаемости
   - Запрещены символы: < > {{ }} ` $ & | ;

2. ВАЛИДАЦИЯ:
   - Массивы labels и values ДОЛЖНЫ быть одинаковой длины
   - Все элементы в values должны быть положительными числами
   - Сумма values может быть не 100% (Plotly сам нормирует)

3. КАЧЕСТВО:
   - Если данных слишком мало (< минимум) или слишком много (> максимум) - 
  выбери другой тип визуализации или агрегируй данные
   - Заголовок должен отражать суть распределения
   - Используй понятные короткие названия для сегментов

# ПРИМЕРЫ:

ХОРОШО:
{{
  "type": "plotly",
  "chart_type": "pie",
  "data": {{
    "labels": ["Канцтовары", "Электроника", "Книги"],
    "values": [45000, 120000, 35000]
  }},
  "layout": {{
    "title": "Распределение продаж по категориям"
  }}
}}

НЕПРАВИЛЬНО (отрицательное значение):
{{
  "data": {{
    "labels": ["A", "B"],
    "values": [50, -10]  // ОШИБКА: отрицательное значение
  }}
}}

Верни ТОЛЬКО JSON без дополнительного текста.
""",
    "scatter": """
Ты специалист по визуализации данных. Создай JSON конфигурацию для точечной диаграммы (scatter plot).

# ДАННЫЕ ДЛЯ ГРАФИКА:
{data_context}

# НАЗВАНИЕ ГРАФИКА:
{title_section}

# ФОРМАТ ОТВЕТА - строго JSON:
{{
  "type": "plotly",
  "chart_type": "scatter",
  "data": {{
    "x": [10, 20, 30, 40],      # массив чисел (значения оси X)
    "y": [100, 150, 130, 200]   # массив чисел (значения оси Y)
  }},
  "layout": {{
    "title": "Краткий заголовок",      # строка до 50 символов
    "xaxis_title": "Название оси X",   # строка до 30 символов
    "yaxis_title": "Название оси Y"    # строка до 30 символов
  }}
}}

# ПРАВИЛА И ОГРАНИЧЕНИЯ:
1. БЕЗОПАСНОСТЬ:
   - Только числа в x и y
   - Минимум 5 точек для выявления закономерностей
   - Оптимально 10-50 точек
   - Для корреляции нужны парные значения (x,y)
   - Запрещены символы: < > {{ }} ` $ & | ;

2. ВАЛИДАЦИЯ:
   - Массивы x и y ДОЛЖНЫ быть одинаковой длины
   - Все элементы в x и y должны быть числами
   - Подписи должны быть краткими и понятными

3. КАЧЕСТВО:
    - Если данных слишком мало (< минимум) или слишком много (> максимум) - 
  выбери другой тип визуализации или агрегируй данные
   - Заголовок должен отражать суть корреляции
   - Подписи осей должны быть информативными
   - Используй осмысленные названия осей (например, "Цена" vs "Спрос")

# ПРИМЕРЫ:

ХОРОШО:
{{
  "type": "plotly",
  "chart_type": "scatter",
  "data": {{
    "x": [10, 20, 30, 40],
    "y": [100, 150, 130, 200]
  }},
  "layout": {{
    "title": "Зависимость спроса от цены",
    "xaxis_title": "Цена, руб",
    "yaxis_title": "Спрос, шт"
  }}
}}

НЕПРАВИЛЬНО (разная длина массивов):
{{
  "data": {{
    "x": [1, 2, 3],
    "y": [10, 20]  // ОШИБКА: 3 элемента в x, но 2 в y
  }}
}}

Верни ТОЛЬКО JSON без дополнительного текста.
""",
    "histogram": """
Ты специалист по визуализации данных. Создай JSON конфигурацию для гистограммы.

# ДАННЫЕ ДЛЯ ГРАФИКА:
{data_context}

# НАЗВАНИЕ ГРАФИКА:
{title_section}

# ФОРМАТ ОТВЕТА - строго JSON:
{{
  "type": "plotly",
  "chart_type": "histogram",
  "data": {{
    "x": [25, 30, 35, 40, 45, 50, 55, 60]  # массив чисел (значения для гистограммы)
  }},
  "layout": {{
    "title": "Краткий заголовок",      # строка до 50 символов
    "xaxis_title": "Название оси X",   # строка до 30 символов
    "yaxis_title": "Частота"           # строка до 30 символов
  }}
}}

# ПРАВИЛА И ОГРАНИЧЕНИЯ:
1. БЕЗОПАСНОСТЬ:
   - Только числа в x
   - Минимум 10 значений
   - Оптимально 30-100 значений
   - Для распределения нужны однородные данные
   - Запрещены символы: < > {{ }} ` $ & | ;

2. ВАЛИДАЦИЯ:
   - Поле x ДОЛЖНО быть массивом чисел
   - Подписи должны быть краткими и понятными

3. КАЧЕСТВО:
   - Если данных слишком мало (< минимум) или слишком много (> максимум) - 
  выбери другой тип визуализации или агрегируй данные
   - Заголовок должен отражать суть распределения
   - Подписи осей должны быть информативными
   - Используй осмысленные названия (например, "Возраст" vs "Частота")

# ПРИМЕРЫ:

ХОРОШО:
{{
  "type": "plotly",
  "chart_type": "histogram",
  "data": {{
    "x": [25, 30, 35, 40, 45, 50, 55, 60, 28, 33, 41]
  }},
  "layout": {{
    "title": "Распределение возрастов",
    "xaxis_title": "Возраст, лет",
    "yaxis_title": "Частота"
  }}
}}

НЕПРАВИЛЬНО (не числа в x):
{{
  "data": {{
    "x": ["A", "B", "C"]  // ОШИБКА: строка вместо числа
  }}
}}

Верни ТОЛЬКО JSON без дополнительного текста.
""",
    "table": """
Ты специалист по визуализации данных. Создай JSON конфигурацию для таблицы.

# ДАННЫЕ ДЛЯ ТАБЛИЦЫ:
{data_context}

# НАЗВАНИЕ ТАБЛИЦЫ:
{title_section}

# ФОРМАТ ОТВЕТА - строго JSON:
{{
  "type": "plotly",
  "chart_type": "table",
  "data": {{
    "header": ["Метрика", "Значение", "Единица"],  # массив строк (заголовки столбцов)
    "cells": [                                    # массив массивов (данные строк)
      ["Выручка", "1.2M", "руб"],
      ["EBITDA", "300k", "руб"],
      ["Чистая прибыль", "180k", "руб"]
    ]
  }},
  "layout": {{
    "title": "Краткий заголовок"  # строка до 50 символов
  }}
}}

# ПРАВИЛА И ОГРАНИЧЕНИЯ:
1. БЕЗОПАСНОСТЬ:
   - Только строки в header и cells
   - Минимум 2 колонки и 1 строка
   - Оптимально 3-5 колонок, 3-10 строк
   - Максимум 6 колонок и 15 строк для читаемости
   - Запрещены символы: < > {{ }} ` $ & | ;

2. ВАЛИДАЦИЯ:
   - Все элементы в header и cells должны быть строками
   - Количество столбцов в header и в каждой строке cells ДОЛЖНО совпадать
   - Подписи должны быть краткими и понятными

3. КАЧЕСТВО:
   - Если данных слишком мало (< минимум) или слишком много (> максимум) - 
  выбери другой тип визуализации или агрегируй данные
   - Заголовок должен отражать суть данных
   - Используй понятные короткие названия столбцов

# ПРИМЕРЫ:

ХОРОШО:
{{
  "type": "plotly",
  "chart_type": "table",
  "data": {{
    "header": ["Показатель", "Значение", "Ед. изм."],
    "cells": [
      ["Выручка", "1 200 000", "руб"],
      ["Прибыль", "180 000", "руб"],
      ["Рентабельность", "15%", "%"]
    ]
  }},
  "layout": {{
    "title": "Финансовые показатели"
  }}
}}

НЕПРАВИЛЬНО (несоответствие количества столбцов):
{{
  "data": {{
    "header": ["A", "B"],      // 2 столбца
    "cells": [
      ["X", "Y", "Z"]  // ОШИБКА: 3 столбца
    ]
  }}
}}

Верни ТОЛЬКО JSON без дополнительного текста.
"""
}


def get_visualization_prompt(vis_type: str, data_context: str, chart_title: str = "") -> str:
    """
    Универсальная функция для получения промпта визуализации
    """
    if vis_type not in VISUALIZATION_PROMPTS:
        available_types = list(VISUALIZATION_PROMPTS.keys())
        raise ValueError(f"Unsupported visualization type: {vis_type}. Available: {available_types}")

    template = VISUALIZATION_PROMPTS[vis_type]
    title_section = f"# ЖЕЛАЕМЫЙ ЗАГОЛОВОК: {chart_title}" if chart_title else ""

    return template.format(
        data_context=data_context,
        title_section=title_section
    )